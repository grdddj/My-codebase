<!DOCTYPE html>
<html lang="en">
    <head>
        <script type="text/javascript" src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
        <script type="text/javascript" src="https://unpkg.com/web3@0.20.5/dist/web3.min.js"></script>

<script type="text/javascript">
/* Autogenerated - do not fiddle */
if(typeof(Contracts)==="undefined") var Contracts={};
(function(module, Contracts) {
    var data={
        address: "0x9fc6561a6f54e96a3d53b27f03ec81a9dfdcea4b",
        network: "rinkeby",
        endpoint: "https://rinkeby.infura.io/",
        abi: [{"constant":false,"inputs":[],"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"idToPlayer","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_address","type":"address"}],"name":"getPlayer","outputs":[{"name":"","type":"address"},{"name":"","type":"uint256"},{"name":"","type":"string"},{"name":"","type":"uint256"},{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_player","type":"address"}],"name":"getName","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_player","type":"address"}],"name":"getRecord","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getLastGeneratedNumber","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_player","type":"address"}],"name":"getNumberOfTrials","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_number","type":"uint256"},{"name":"_bet","type":"uint256"}],"name":"random","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"startAgain","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"_name","type":"string"}],"name":"createPlayer","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[{"name":"id","type":"uint256"}],"name":"getAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"players","outputs":[{"name":"owner","type":"address"},{"name":"id","type":"uint256"},{"name":"name","type":"string"},{"name":"balance","type":"uint256"},{"name":"record","type":"uint256"},{"name":"numberOfTrials","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_player","type":"address"}],"name":"getBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getNumberOfPlayers","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"}]
    };
    Contracts["BettingGame"]=data;
    module.exports=data;
})((typeof(module)==="undefined"?{}:module), Contracts);

(function (Contract) {
    var web3_instance;
    var instance;
    var accounts;

    var address;
    var recordy = [5, 6];


    function init(cb) {
        web3_instance = new Web3(
            (window.web3 && window.web3.currentProvider) ||
            new Web3.providers.HttpProvider(Contract.endpoint));

        accounts = web3.eth.accounts;

        var contract_interface = web3_instance.eth.contract(Contract.abi);
        instance = contract_interface.at(Contract.address);
        cb();
    }

    function getAddress() {
        var address = accounts[0].toString();
        if (address.length > 0) {
            $("#address").html(address);
        }
        else {
            $("#address").html("Please login into metamask");
        }
    }

    function getBalance(address) {
        instance.getBalance(address, function (error, result) {
            if (error) {
                alert(error);
            }
            else {
                $("#balance").html(result.toString());
            }
        });
    }

    function getNumberOfPlayers() {
        instance.getNumberOfPlayers(function (error, result) {
            var count;
            if (error) {
                alert(error);
            }
            else {
                $("#number_of_players").html(result.toString());
            }
        });
    }


    function getName(address, cb) {
        instance.getName(address, function (error, result) {
            if (error) {
                alert(error);
            }
            else {
                //  $("#get_nick").html(result);
                cb(result);
            }
        });
    }

    function getRecord(address, cb) {
        instance.getRecord(address, function (error, result) {
            if (error) {
                alert(error);
            }
            else {
                //$("#record").html(result.toString());
                cb(result);
            }
        });
    }

    function getGeneratedNumber() {
        instance.getLastGeneratedNumber(function (error, result) {
            if (error) {
                alert(error);
            }
            else {
                $("#generated_number").html(result.toString());
            }
        });
    }

    function waitForReceipt(txHash, cb) {
        web3_instance.eth.getTransactionReceipt(txHash, function (error, receipt) {
            if (error) {
                alert(error);
            }
            else if (receipt !== null) {
                cb(receipt);
            }
            else {
                window.setTimeout(function () {
                    waitForReceipt(txHash, cb)
                }, 5000);
            }
        });
    }

    function register() {
        var name = $("#nick").val();
        if (name.length > 0 && document.getElementById('agreement').checked) {
            // GAS CONSUMED = 130 000
            instance.createPlayer.sendTransaction(name, { from: accounts[0], gas: 300000, value: 1000000000000000 }, function (error, txHash) {
                if (error) {
                    alert("Transaction didn't get through - try again!");
                }
                else {
                    waitForReceipt(txHash, function (receipt) {
                        if (receipt.status === "0x1") {
                            getNumberOfPlayers();
                            getAddress();
                            getName(accounts[0], function (result) {
                                $("#get_nick").html(result.toString());
                            });
                            getBalance();
                            getRecord(accounts[0], function (result) {
                                $("#record").html(result.toString());;
                            });
                            clearTable();
                            getAllPlayers();
                        }
                        else {
                            alert("Receive status failed");
                        }
                    });
                }
            });
        }
        else if (!document.getElementById('agreement').checked && !name.length > 0) {
            alert("Please state that you are older than 21 and pick a non-zero name");
        }
        else if (!document.getElementById('agreement').checked) {
            alert(name + ", please state that you are older than 21");
        }
        else if (!name.length > 0) {
            alert("Please pick a non-zero name");
        }
        else {
            alert("Something went wrong, check the input data");
        }


    }

    function random() {
        var number = parseInt($("#number").val());
        var bet = parseInt($("#bet").val());
        if (number > 0 && number <= 100) {
            // GAS CONSUMED = 35 000
            instance.random.sendTransaction(number, bet, { from: accounts[0], gas: 300000 }, function (error, txHash) {
                if (error) {
                    alert("Transaction didn't get through - try again!");
                }
                else {
                    waitForReceipt(txHash, function (receipt) {
                        if (receipt.status === "0x1") {
                            getBalance(accounts[0]);
                            getRecord(accounts[0], function (result) {
                                $("#record").html(result.toString());;
                            });
                            getGeneratedNumber();
                            clearTable();
                            getArrayOfRecords();
                        }
                        else {
                            alert("Receive status failed");
                        }
                    });
                }
            });
        }
        else {
            alert("Requirements for betting not met, check it once more! Choose a number from 1 to 100");
        }
    }

    function startAgain() {
        // GAS CONSUMED = 35 000
        instance.startAgain.sendTransaction({ from: accounts[0], gas: 300000, value: 1000000000000000 }, function (error, txHash) {
            if (error) {
                alert("Transaction didn't get through - try again!");
            }
            else {
                waitForReceipt(txHash, function (receipt) {
                    if (receipt.status === "0x1") {
                        getBalance(accounts[0]);
                    }
                    else {
                        alert("Receive status failed");
                    }
                });
            }
        });
    }

    // This will prepare the table to be updated - it deletes the old content
    function clearTable() {
        let x = document.getElementById("myTable").rows.length;
        for (let i = 0; i < x - 1; i++) {
            document.getElementById("myTable").deleteRow(-1);
        }
    }



    function getAllPlayers() {
        instance.getNumberOfPlayers(function (error, numberOfPlayers) {
            if (error) {
                alert(error);
            }
            else {
                for (let i = 1; i <= numberOfPlayers; i++) {
                    instance.getAddress(i, function (error, address) {
                        if (error) {
                            alert(error);
                        }
                        else {
                            printPlayerDetails(address);
                        }
                    });
                }
            }
        }
        );
    }


    function getArrayOfRecords() {

        let records = [];
        let sortedRecords = [];
        let indexes = [];
        let x = 5;

        instance.getNumberOfPlayers(function (error, numberOfPlayers) {


            if (error) {
                alert(error);
            }
            else {


                for (let i = 1; i <= numberOfPlayers; i++) {



                    instance.getAddress(i, function (error, address) {
                        if (error) {
                            alert(error);
                        }
                        else {

                            instance.getRecord(address, function (error, record) {
                                if (error) {
                                    alert(error);
                                }
                                else {
                                    //recordsArray(records, record);
                                    //  x = record;

                                    //recordy.push(77);
                                    //alert(record);

                                    // let y = "#record" + i;
                                    //  $(y).html(record.toString());
                                    // alert("before");

                                    records[i - 1] = record;

                                }
                            });
                        }
                    });


                }
            }
        });


        setTimeout(function () {

            // It is not possible to write sortedRecords = records ... then the records would change as well
            records.forEach(function (value) {
                sortedRecords.push(value);
            });


            sortedRecords.sort(function (a, b) { return b - a });


            sortedRecords.forEach(function (value) {
                let x = records.indexOf(value);
                indexes.push(x + 1);
            });

            //Making it TOP10 - reducing the size of the array to 10 (generaly any number)
            let number = 10;
            while (indexes.length > number) {
                indexes.pop();
            }



            getPlayerAddresses(indexes);
        }, 2000);


    }

    function getPlayerAddresses(ids) {


        // Making an empty table of a right size - to be able to fill arbitrary row any time
        for (let i = 1; i <= ids.length; i++) {
            let table = document.getElementById("myTable");
            let row = table.insertRow(i);
        }

        ids.forEach(function (value) {



            instance.getAddress(value, function (error, _address) {
                if (error) {
                    alert(error);
                }
                else {

                    address = _address;


                    let table = document.getElementById("myTable");

                    let x = table.rows.length;
                    // xx is to ensure it will get recorded on the right row - due to big latency
                    let xx = ids.indexOf(value) + 1;

                    let row = table.insertRow(xx);
                    let cell1 = row.insertCell(0);
                    let cell2 = row.insertCell(1);
                    let cell3 = row.insertCell(2);
                    let cell4 = row.insertCell(3);

                    cell1.innerHTML = xx.toString();

                    cell3.innerHTML = address.toString();

                    getName(address, function (result) {
                        cell2.innerHTML = result;
                    });

                    getRecord(address, function (result) {
                        cell4.innerHTML = result.toString();
                    });
                }
            });


        });
    }


    $(document).ready(function () {
        init(function () {


            getNumberOfPlayers();
            getAddress();
            getName(accounts[0], function (result) {
                $("#get_nick").html(result.toString());
            });
            getBalance(accounts[0]);
            getRecord(accounts[0], function (result) {
                $("#record").html(result.toString());
            });
            getGeneratedNumber();

            getArrayOfRecords();



        });

        $("#register").click(function () {
            register();
        });

        $("#submit_bet").click(function () {
            random();
        });

        $("#start_again").click(function () {
            startAgain();
        });

        $("#addTable").click(function () {
            addTable();
        });

    });
})(Contracts['BettingGame']);
</script>


        <style type="text/css">
body {
    background-color: midnightblue;
    color: darksalmon;
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    text-align: center;
}

table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: 100%;
}

td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
}


</style>

    </head>
    <body>
        <h1>Betting game</h1>
        <p>Description: This is my first try to create a decentralized application, in the form of a betting game. The game is running on Ethereum Rinkeby test network.</p>
        <p>Rules: You are betting on choosing higher number than randomly generated number from 1 to 100. Your possible win is proportionate to the risk you take - the smaller number you bet on, the more you can win - however, with a smaller chance. </p>

        <input type="text" id="nick" placeholder="Write your nick..."/>
        <input type="checkbox" id="agreement"> I am over 21
        <button id="register">Start playing!</button>


        <h2>ETH address: <span id="address"></span></h2>
        <h2>Nick: <span id="get_nick"></span></h2>
        <h2>My balance: <span id="balance"></span></h2>

        <button id="start_again">Start again with 1000</button>
        <h2>My record: <span id="record"></span></h2>


        <input type="number" id="number" placeholder="Write your number..."/>
        <input type="number" id="bet" placeholder="Write your bet..."/>
        <button id="submit_bet">Submit bet</button>
        <h2>Generated number: <span id="generated_number"></span></h2>



    <br>
            <h3>Leaderboard - TOP10</h3>


                <table id="myTable">
                <thead>
                <tr>
                    <th></th>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Record</th>
                </tr>
                </thead>



                <tbody>
                </tbody>

                </table>


    <table id="myTable2">

    </table>





            <h2>Number of players: <span id="number_of_players"></span></h2>
    </body>
</html>
